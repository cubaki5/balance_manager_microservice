## МИКРОСЕРВИС ДЛЯ РАБОТЫ С БАНАЛАНСОМ ПОЛЬЗОВАТЕЛЯ

Микросервис разработан в рамках тестового задания Avito Backend Internship.

## СОДЕРЖАНИЕ

[О коде](#dop)

[Диаграммы](#diagrams)

[Архитектурные улучшения](#arch)

[Тестирование](#test)

[Вопросы по ТЗ](#ques)

[Инструкция по запуску](#instruc)

[Примеры запросов и ответов](#examples)


## О коде <a name="dop"></a>

Придерживаюсь подхода SOLID, так в проекте реализованы три принципа: SID. Остальные два OL использовать пока не умею :)

При написании проекта были задействованы [golangci-linters](https://github.com/golangci/golangci-lint)
(goimports, goconst, gosec, govet, ineffassign, revive, typecheck, unused), [pre-commit-hook](https://pre-commit.com/), соответсвующее .yml файлы лежат в репозитории.

Для генерации golang кода из sql скриптов использовался [sqlc](https://sqlc.dev/). В качестве СУБД был выбран mysql. 

## Диаграммы <a name="diagrams"></a>

### диаграмма зависимостей пакетов
  ![диаграмма зависимостей пакетов](https://github.com/cubaki5/balance_manager_microservice/blob/master/diagrams/dependences.jpg)
### диаграмма связи структур и интерфейсов
  ![диаграмма связи структур и интерфейсов](https://github.com/cubaki5/balance_manager_microservice/blob/master/diagrams/link.jpg)
### диаграмма структуры базы данных
  ![диаграмма связи структур и интерфейсов](https://github.com/cubaki5/balance_manager_microservice/blob/master/diagrams/db.jpg)

## Архитектурные улучшения <a name="arch"></a>

В текущей реализации данные для отчётов хранятся в реляционной БД, и на каждый запрос преобразуются в csv формат и возвращаются пользователю. 
В целях оптимизации можно: 
    - формировать отчёты, как статические файлы, и сохранять в файловой системе или специализированной БД;
    - давать доступ к файлам с отчётом не через го сервер, а через Fronted сервер.

Так как в ТЗ не были указаны сведения о нагрузке микросервиса, в настоящей реализации все таблицы находятся в одной базе данных, и все запросы обрабатываются
в транзакциях с уровнем изоляции REPEATABLE READ. Однако есть непропорциональность в важности данных таблиц и нагрузке.
Запросы на получение бухгалтерского отчёта и истории транзакций скорее всего запрашиваются реже, чем запросы по работе с балансом,
и актуальность этой информации не является критической.
Поэтому возможное улучшение - это разбить данный сервис на три:
- высоконагруженный, с высоким уровнем изоляции работающий с балансом;
- низконагруженной, с пониженным уровнем изоляции, работающий с историей и отчётами;
- маршрутизатор, отправляющий запрос на нужный микросервис.

![Улучшенная архитектура](https://github.com/cubaki5/balance_manager_microservice/blob/master/diagrams/arch.jpg)

Что это нам даёт:
- повышение устойчивости системы. Например, при отказе сервиса баланса, сервис истории и отчётов продолжит работу;
- возможность масштабирования высоконагруженного сервиса вширь;
- увеличение скорости работы низконагруженного сервиса за счёт понижения уровня изоляции транзакций;
- а также облегчает работу в большой команде разработчиков ;)

## Тестирование <a name="test"></a>
Code coverage составляет 60,7%, без учёта сгенерированных пакетов покрытие тестами составляет 70% (файл [coverage.out](https://github.com/cubaki5/balance_manager_microservice/blob/master/coverage.out)).

Также был задействован инструмент [мутационных тестов от avito-tech :)](https://github.com/avito-tech/go-mutesting#how-do-i-use-go-mutesting).  
Выжимка из сгенерированного отчёта ([report_mutations.json](https://github.com/cubaki5/balance_manager_microservice/blob/master/report_mutations.json)):
  
```  
  "stats": {
  "totalMutantsCount": 72,
  "killedCount": 72,
  "notCoveredCount": 0,
  "escapedCount": 0,
  "errorCount": 0,
  "skippedCount": 0,
  "timeOutCount": 0,
  "msi": 1,
  "mutationCodeCoverage": 0,
  "coveredCodeMsi": 0
  }
```

## Вопросы по ТЗ  <a name="ques"></a>
1. Нужно ли учитывать копейки при работе с денежными средствами?
    - *Денежные средства считаются целочисленным типом.*
2. В пункте ТЗ "Задача" говорится также о реализации "перевода средств от пользователя к пользователю", нужно ли его реализовать?
    - *В описании задания об этой задаче не говорилось, поэтому данная операция не предусмотрена в созданном микросервисе, однако может быть добавлена.*
3. Нужно ли в истории транзакций сохранять записи по резервированию и разрезервированию средств?
    - *В истории транзакций сохраняется эта информация.*
4. В примере отчёта для бухгалтерии указаны названия услуг, однако не сказано, откуда брать названия услуг.
    - *Вместо названия услуг микросервис в отчёте указывает ID услуги.*
5. В примере отчёта для бухгалтерии нет шапки таблицы, делать ли её?
    - *Микросервис возвращает отчёт без шапки, как в примере.*
6. В дополнительном задании 1 на выходе необходимо отдавать "ссылку на CSV файл", однако неясно, где хранить этот файл, какое у него должно быть название и тп.
    - *Из-за неопределённостей, при решении доп задания 1 было решено давать не ссылку на csv файл, а данные, в формате csv.*
7. В дополнительном задании 2 необходимо формировать список с "комментариями откуда и зачем были начислены/списаны средства", однако неясно, откуда брать конкретные названия услуг.
    - *При формировании списка по заданию 2 микросервис использует ID услуги.*
8. Также в доп задании 2 необходимо предусмотреть пагинацию. Появился вопрос, что выводить в ответе, когда по введённым параметрам на странице нет записей об истории (история короче), пустую страницу или записи выше?
    - *В такой ситуации микросервис возвращает пустое тело.*
9. По формулировке задания 2 необходимо предусмотреть сортировку "по дате и сумме". Как должна выглядеть сортировка и по дате, и по сумме?
   - *В параметрах данного запроса есть возможность поставить сортировку и по дате, и по сумме. Однако, механизм сортировки отдан на откуп базе данных.*
10. В доп. задании 2 не указано, в каком формате необходимо возвращать историю транзакций.
    - *Было решено оформлять историю, как в доп задании 1, т.е. возвращать историю в формате csv.*
11. Можно ли доверять сервисам, которые используют данный микросервис?
    - *Так как микросервис работает с такими важными вещами, как баланс пользователя, была добавлена валидация данных, пришедших из вне.*

## Инструкция по запуску <a name="instruc"></a>

1. ```git clone https://github.com/cubaki5/balance_manager_microservice```

2. ```docker compose build```

3. ```docker compose up```

Приложение запущено и готово к работе!

## Примеры запросов и ответов <a name="examples"></a>

Ознакомиться со Swagger 2.0 API документаций можно [здесь](http://localhost:1323/swagger/index.html) при запущенном приложении.

Примеры curl запросов:

- начисление средств на определённый аккаунт

  ```
  curl --location --request POST 'http://localhost:1323/fund/accrual' --header 'Content-Type: application/json' --data-raw '{"user_id":3,"income":1500}'
  ```

- резервирование средств на аккаунте

    ```
  curl --location --request POST 'http://localhost:1323/fund/reservation' --header 'Content-Type: application/json' --data-raw '{"user_id":3,"service_id":666,"order_id":83,"cost":300}'
  ```

- признание выручки

  ```
  curl --location --request POST 'http://localhost:1323/fund/payment_acceptance' --header 'Content-Type: application/json' --data-raw '{"user_id":3,"service_id":666,"order_id":83,"cost":300}'
  ```

- разрезервирование средств

  ```
  curl --location --request POST 'http://localhost:1323/fund/payment_rejection' --header 'Content-Type: application/json' --data-raw '{"user_id":3,"service_id":666,"order_id":83,"cost":300}'
  ```

- информация о балансе пользователя

  ```
  curl --location --request GET 'http://localhost:1323/fund/balance' --header 'Content-Type: application/json' --data-raw '{"user_id":3}'
  ```

    Response Body:

    `{
        160
    }`

- отчёт для бухгалтерии

    ```
  curl --location --request GET 'http://localhost:1323/report/accounting' --header 'Content-Type: application/json' --data-raw '{"year":2022,"month":11}'
  ```

  Response Body:

  ``` 
  { 
  11;15900
  12;13000
   }
- история транзакций с возможностью сортировки по дате и сумме и предусмотренной пагинацией

    ```
  curl --location --request GET 'http://localhost:1323/report/transactions_history?sortDate=0&sortSum=1&page=1&limit=100' --header 'Content-Type: application/json' --data-raw '{"user_id":3}'
  ```

  Response Body:

    ``` 
    { 
    начисление;источник пополнения;2022-11-12T19:28:27Z;1500
    оплата;оплата заказа №1 по покупке 33;2022-12-12T19:28:27Z;600
    возврат;возврат стоимости заказа №2 по покупке 43;2022-12-14T19:28:27Z;250
     }

